---
description: MVP dev principle: break freely, restart locally
alwaysApply: true
---

## Local MVP rules (break freely)

- **No backward compatibility required**. It’s OK to break APIs/schemas and refactor aggressively.
- Assume the user can restart backend/frontend and reset local state at any time.
- Prefer the simplest working approach over compatibility layers/migrations.

## Code size & professionalism (keep files small)

- Avoid generating or growing **large files**. Prefer small, composable modules.
- **Hard cap**: if a file would exceed ~300 lines, refactor/split it (extract hooks, helpers, components, types).
- **Soft cap**: aim for <200 lines per file for new code.
- Route/page files should mostly compose existing pieces; heavy logic belongs in `use*` hooks or `lib/*`.

## Validate changes (fast defaults)

- Prefer fast checks over production builds.
- Don’t start/stop dev servers unless explicitly asked; assume the developer runs them.
- Prefer running autofix before validation:
  - backend: `make fix` (or explicitly `make fix-backend`)
  - frontend: `make fix-frontend`
- Default (prefer scoped `make` targets from repo root):
  - backend: `make test` (or explicitly `make backend-test`)
  - frontend: `make types` (or explicitly `make frontend-types`)
- Run E2E only when UI/API/map behavior changes:
  - `cd frontend && E2E_FAST=1 E2E_REUSE_ONLY=1 npm run -s e2e`
- Only run `cd frontend && npm run -s build` when bundling-related (Vite config/deps/import paths) or build-only failures appear.

- Extra (when needed):
  - backend lint/sanity: `make lint` (or `make backend-lint`)
  - frontend lint (may currently fail until lint baseline is cleaned up): `make frontend-lint`
  - backend integration tests: `make test-integration`
  - fast “both sides” check: `make test-all`

## Guardrails (avoid common regressions)

- **Deterministic E2E**: avoid wheel/drag-based map interactions; prefer request interception (`page.route`) and programmatic Plotly relayout.
- **Map invariants**:
  - keep user map view stable unless intentionally focusing results
  - preserve highlight IDs across plot refresh (round-trip via `layout.meta`)
- **Persistence**: don’t write huge Plotly payloads to localStorage; fall back to text-only message persistence if needed.

## Hot reload & when to restart

Hot reload should normally work (`npm run dev` + `uv run fastapi dev main.py`).
Ask the developer to restart **frontend** when:

- deps/config changed (`frontend/package*.json`, `frontend/vite.config.ts`)
- build-time env changes (`frontend/.env*`)
- HMR is stuck

Ask the developer to restart **backend** when:

- deps changed (`backend/requirements.txt`, `backend/pyproject.toml`, `backend/uv.lock`)
- startup/import-time env or import order changed
- reloader is stuck (import errors, changes not taking effect)

## Frontend rules

Use the latest version of Shadcn to install new components, like this command to add a button component:

```bash
pnpx shadcn@latest add button
```